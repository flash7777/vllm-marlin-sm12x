#!/usr/bin/env bash
set -Eeuo pipefail

# vllm-turbo: Ray Worker (PGX ThinkStation) for TP=2
# Run on PGX after head is started on DGX

NAME="vllm-turbo-worker"
HEAD_IP="${HEAD_IP:-192.168.0.117}"
WORKER_IP="${WORKER_IP:-192.168.0.116}"

echo "Starting Ray worker: ${NAME} at ${WORKER_IP}"
echo "Connecting to head: ${HEAD_IP}:6379"

podman run -d \
  --replace \
  --name "${NAME}" \
  --device nvidia.com/gpu=all \
  --security-opt=label=disable \
  --hooks-dir=/usr/share/containers/oci/hooks.d \
  --device /dev/infiniband/uverbs0 \
  --device /dev/infiniband/rdma_cm \
  --ipc=host \
  --network=host \
  -v /data/tensordata:/data/tensordata \
  -v "${HOME}/.cache/huggingface:/root/.cache/huggingface" \
  -e HEAD_IP="${HEAD_IP}" \
  -e WORKER_IP="${WORKER_IP}" \
  -e NUM_GPUS=1 \
  -e NCCL_IB_HCA=rocep1s0f0 \
  -e NCCL_SOCKET_IFNAME=enp1s0f0np0 \
  vllm-turbo:latest ray-worker

echo "Ray worker started, connected to ${HEAD_IP}:6379"
echo "Next: start serve on head node"
